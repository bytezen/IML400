<!doctype html>
<html>
  <head>
  	<link rel="stylesheet" type="text/css" href="css/main.css"/>
  	<script type="text/javascript" src="js/lib/jquery-2.1.4.min.js"></script>    
    <script>

    	$(document).ready(function(){
            // -- cool jQuery hack to test for existence:
            // src: http://stackoverflow.com/questions/920236/how-can-i-detect-if-a-selector-returns-null
            $.fn.exists = function () {
                return this.length !== 0;
            }

    		// -------------
    		// Model 

    		var $model = $('#model');
    		var QUESTION_COUNT = 3;
    		var CARD_COUNT = 4;
    		
            // ---
            // data vars
            // ---
    		$model.listeners = [];
            $model.selections = [];

    		// ---
    		// funcs
    		// ---
    		$model._setQuestionIndex = function(ind) {
    			//set data value
    			$.data($model, 'currentQuestion', ind);

    			//alert listeners that data has changed
    			console.log('setting question index and...');
    			var events = [];
    			var eventName = "change:choice";
    			
    			//create events for each card
    			for(i=0; i < CARD_COUNT;i++) {
    				events.push( $.Event(eventName + i, {'newValue': $model.getChoice(i)}) );
    			}	
    			

    			//trigger each listener with an event that a card has changed
    			$.each($model.listeners, function(ind,lstnr){
    				var e = events[ind];

    				//$.Event("change:choice1", {'newValue': $model.getChoice(ind)});    			
                    if(e) {
                        console.log('   ... firing event: ' + e.type);
                        lstnr.trigger(e);                        
                    }
    			});

    		}


    		$model._getQuestionIndex = function() {
    			return $.data( $model, 'currentQuestion');
    		}

    		$model._getChoices = function() {
    			return $.data( $model, 'choices');
    		}


    		// retrieve the choices that are associated with
    		// the current question stored in the model
    		$model.getCurrentChoices = function() {
    			var ind = $model._getQuestionIndex();
    			var choices = $model._getChoices();
    			
    			if(ind < choices.length) {
    				return choices[ind];	
    			} else {
    				return null;
    			}
    			
    		}

    		// get a specific choice from the current choices
    		$model.getChoice = function(ind) {
    			var choices = $model.getCurrentChoices();
    			//console.log("{getChoice} choices " + choices[ind].value + " ind = " + ind);
    			if(ind < choices.length) {
    				return choices[ind].value;
    			}

    			return null;
    		}

    		// set up the model to get the next question
    		// if there are no more questions than 
    		// this will return to the first question
    		$model.advanceQuestion = function() {
    			var ind = $model._getQuestionIndex();
    			var choices = $model._getChoices();

    			ind++;
    			//ind = ind % QUESTION_COUNT;

    			// Make sure the index does not go beyond
    			// the last question
    			if(ind >= QUESTION_COUNT) {
    				ind = QUESTION_COUNT - 1;
    			}

				$model._setQuestionIndex(ind);
    		}

            $model.addSelection = function(value) {
                $model.selections.push(value);

                //trigger each listener that selection has changed
                var e = $.Event('change:selections', {'newValue': value});                 
                $.each($model.listeners, function(ind,lstnr){
                    console.log('   ... firing event: ' + e.type);
                    console.log('\t\t listener --> ' + lstnr.prop('id'));
                    lstnr.trigger(e);
                    // console.log('    ... firing events');
                    // lstnr.trigger(e2);
                });
            }

    		$model.resetModel = function() {
    			ind = 0;    			
    		}

    		
    		//load the model
    		function loadModel(data) {
    			console.log("loading the model");
    			$.data( $model, 'currentQuestion', 0);
    			$.data( $model, 'choices', data.choices);
    		}

    		//----------

			//-------
    		// Controller
    		//-------
    		var ctrl = (function() {
    			var instance;

    			function createInstance() {
    				var obj = new Object();
    				obj.sayHello = sayHello;
    				obj.registerView = registerView;
    				obj.initialize = initialize;
                    obj.onClickCard = onClickCard;
    				return obj;
    			}

    			function initialize() {
    				var $card0 = $('#card0');
    				var $card1 = $('#card1');
					var $card2 = $('#card2');
					var $card3 = $('#card3');
                    var $hud   = $('#HUD');
                    

                    if(! ($card0.exists() && 
                        $card1.exists() && $card2.exists() && $card3.exists() && $hud.exists()) ) {
                        console.log("### ERROR -- uninitialized jQ selectors ###");
                    }
    				//------------------
    				//register views
    				
    				//card1
		    		$card0.on('change:choice0', function(e){
    					console.log("{onChange:choice0} newValue = " + e.newValue);
		    			
		    			$card0.html(e.newValue);
		    		});

    				this.registerView($card0);

    				//card1
    				$card1.on('change:choice1', function(e){
    					console.log("{onChange:choice1} newValue = " + e.newValue);
    					$card1.html(e.newValue);
    				});
    				this.registerView($card1);

    				//card2
    				$card2.on('change:choice2', function(e){
    					console.log("{onChange:choice2} newValue = " + e.newValue);    					
    					$card2.html(e.newValue);
    				});
    				this.registerView($card2);

					//card3
    				$card3.on('change:choice3', function(e){
    					console.log("{onChange:choice3} newValue = " + e.newValue);    					
    					$card3.html(e.newValue);
    				});
    				this.registerView($card3);

    				//------------------

    				//------------------
    				//click handlers for the card
                    //TODO: find idiomatic way to do this
                    var ctrlHandle = this;                   

                    $('.card').on('click', function(e) {
                        ctrlHandle.onClickCard(e.target);
                    });


    				//------------------
    				// bind the HUD to the selections
                    $hud.on('change:selections', function(e){
                        $(this).append(e.newValue);
                        console.log('HUD change Selections');
                    });
                    this.registerView($hud);
    				//initialize model
    				//initialize view values - automagic

    			}

    			function sayHello(s) { console.log("Hello " + s)};

                function onClickCard(elem) {
                    console.log('YOU SELECTED >>>> ' + elem.innerHTML);
                    // add this to the model list of selections
                    $model.addSelection(elem.innerHTML);
                }

    			function setQuestionContents() {
    				// get current contents
    				// set the contents of the divs to 
    				// the model contents

    			};

    			function revealFortune() {

    			};

    			function onChoiceMade() {
    				//check the current question to make
    				// sure that is not the last question
    				// if not then
    				//advance the question
    				// else
    				// reveal the fortune
    			};

    			function newFortune() {
    				//reset the model
    			};

    			function registerView(elem) {    				
    				if($model.listeners.indexOf(elem) < 0) {
    					$model.listeners.push(elem);
    				}
    			};

    			return {
    				getInstance: function() {
    					if(!instance) {
    						instance = createInstance();
    					}

    					return instance;
    				}
    			};
    		})();



    		var controller = ctrl.getInstance();
    		controller.sayHello('Rhazes');
    		controller.initialize();

    		//-------

    		$.getJSON("data/cootie.json", function(data){ 
    				console.log('got json data: ')
    				loadModel(data);
    				
    				$model._setQuestionIndex(0);
    				//console.log($model.getChoice(0));
    			});


    		$(document).on('click',function(e){
    			console.log("got document click event" + e);
    			$model.advanceQuestion();
    		});

    		$('#test').click(function(){
    			$model.advanceQuestion();
    			console.log($model.getCurrentChoices()[0]);
    		});

    	});
    </script>
  </head>
  <body>
    <div id="cootieCatcherApp">
	    <div id="controller" class="mvc">This is the controller</div>
	    <div id="model" class ="mvc">This should be hidden</div>
		
		<div id="card0" class="card"></div>
		<div id="card1" class="card"></div>
		<div id="card2" class="card"></div>
		<div id="card3" class="card"></div>	
	</div>    
	<div id="HUD">

	</div>
  </body>
</html>