<!doctype html>
<html>
  <head>
  	<link rel="stylesheet" type="text/css" href="css/main.css"/>
  	<script type="text/javascript" src="js/lib/jquery-2.1.4.min.js"></script>    
    <script>

    	$(document).ready(function(){
            // -- cool jQuery hack to test for existence:
            // src: http://stackoverflow.com/questions/920236/how-can-i-detect-if-a-selector-returns-null
            $.fn.exists = function () {
                return this.length !== 0;
            }

    		// -------------
    		// Model 

    		var $model = $('#model');
    		var QUESTION_COUNT = 3;
    		var CARD_COUNT = 4;
    		
            // ---
            // data vars
            // ---
    		$model.listeners = [];
            $model.selections = [];
            $model.fortuneTold = false;

    		// ---
    		// funcs
    		// ---
    		$model._setQuestionIndex = function(ind) {
                if(ind >= QUESTION_COUNT) {
                    return;
                }

    			//set data value
    			$.data($model, 'currentQuestion', ind);

    			//alert listeners that data has changed
    			console.log('setting question index and...');
    			var events = [];
    			var eventName = "change:choice";
    			
    			//create events for each card
    			for(i=0; i < CARD_COUNT;i++) {
    				events.push( $.Event(eventName + i, {'newValue': $model.getChoice(i)}) );
    			}	
    			

    			//trigger each listener with an event that a card has changed
    			$.each($model.listeners, function(ind,lstnr){
    				var e = events[ind];

                    if(e) {
                        console.log('   ... firing event: ' + e.type);
                        lstnr.trigger(e);                        
                    }
    			});

    		}


    		$model.getQuestionIndex = function() {
    			return $.data( $model, 'currentQuestion');
    		}

    		$model._getChoices = function() {
    			return $.data( $model, 'choices');
    		}

            $model._getFortunes = function() {
                return $.data( $model, 'fortunes');
            }

    		// retrieve the choices that are associated with
    		// the current question stored in the model
    		$model.getCurrentChoices = function() {
    			var ind = $model.getQuestionIndex();
    			var choices = $model._getChoices();
    			
    			if(ind < choices.length) {
    				return choices[ind];	
    			} else {
    				return null;
    			}
    			
    		}

    		// get a specific choice from the current choices
    		$model.getChoice = function(ind) {
    			var choices = $model.getCurrentChoices();

    			if(ind < choices.length) {
    				return choices[ind].value;
    			}

    			return null;
    		}

    		// set up the model to get the next question
    		// if there are no more questions than     		
    		$model.advanceQuestion = function() {
    			var ind = $model.getQuestionIndex();
    			var choices = $model._getChoices();

    			ind++;    			    			
                $model._setQuestionIndex(ind);				
    		}

            $model.addSelection = function(sel) {
                $model.selections.push(sel);

                //create a selections change event with the selection value
                var e = $.Event('change:selections', {'newValue': sel});

                //trigger each listener that selection has changed                 
                $.each($model.listeners, function(ind,lstnr){
                    console.log('   ... firing event: ' + e.type);
                    console.log('\t\t listener --> ' + lstnr.prop('id'));
                    lstnr.trigger(e);
                });
            }

            $model.getFortune = function(ind) {
                var fortunes = $model._getFortunes();
                return fortunes[ind];
            }

    		
    		//load the model
    		function loadModel(data) {
    			console.log("loading the model");
    			$.data( $model, 'currentQuestion', 0);
    			$.data( $model, 'choices', data.choices);
                $.data( $model, 'fortunes', data.fortunes);


    		}

    		//----------

			//-------
    		// Controller
    		//-------
    		var ctrl = (function() {
    			var instance;

    			function createInstance() {
    				var obj = new Object();
    				obj.sayHello        = sayHello;
    				obj.registerView    = registerView;
    				obj.initialize      = initialize;
                    obj.onClickCard     = onClickCard;
                    obj.revealFortune   = revealFortune;
                    obj.reset           = reset;
    				return obj;
    			}

    			function initialize() {
    				var $card0 = $('#card0');
    				var $card1 = $('#card1');
					var $card2 = $('#card2');
					var $card3 = $('#card3');
                    var $hud   = $('#HUD');
                    var $fortuneHUD = $('#fortuneHUD');
                    

                    if(! ($card0.exists() && 
                        $card1.exists() && $card2.exists() && $card3.exists() && $hud.exists() && $fortuneHUD.exists()) ) {
                        console.log("### ERROR -- uninitialized jQ selectors ###");
                    }
                    // hide the fortune HUD
                    $fortuneHUD.toggle();

    				//------------------
    				//register views
    				
    				//card1
		    		$card0.on('change:choice0', function(e){
    					console.log("{onChange:choice0} newValue = " + e.newValue);
		    			
		    			$card0.html(e.newValue);
		    		});

    				this.registerView($card0);

    				//card1
    				$card1.on('change:choice1', function(e){
    					console.log("{onChange:choice1} newValue = " + e.newValue);
    					$card1.html(e.newValue);
    				});
    				this.registerView($card1);

    				//card2
    				$card2.on('change:choice2', function(e){
    					console.log("{onChange:choice2} newValue = " + e.newValue);    					
    					$card2.html(e.newValue);
    				});
    				this.registerView($card2);

					//card3
    				$card3.on('change:choice3', function(e){
    					console.log("{onChange:choice3} newValue = " + e.newValue);    					
    					$card3.html(e.newValue);
    				});
    				this.registerView($card3);

    				//------------------

    				//------------------
    				//click handlers for the card
                    //TODO: find idiomatic way to do this
                    var ctrlHandle = this;                   

                    $('.card').on('click', function(e) {
                        ctrlHandle.onClickCard(e.target);
                    });


    				//------------------
    				// bind the HUD to the selections
                    $hud.on('change:selections', function(e){
                        var $p = $("<p></p>");
                        $p.append(e.newValue.value);
                        $p.addClass("selections");

                        $(this).append($p);
                        console.log('HUD change Selections');
                    });

                    this.registerView($hud);
    				
                    //------------------
                    // click handler for the FortuneHUD
                    $fortuneHUD.on('click', function(e) {
                        $fortuneHUD.toggle();
                        $fortuneHUD.html('');
                        $hud.html('');
                        ctrlHandle.reset();
                    });


    			}

    			function sayHello(s) { console.log("Hello " + s)};

                function onClickCard(elem) {                    
                    var cardId = elem.id.charAt(elem.id.length-1);
                    console.log("**** " + cardId);

                    if($model.getQuestionIndex() < QUESTION_COUNT - 1) {
                        var selObj = {'id' : cardId,
                                      'value' : elem.innerHTML};
                        $model.addSelection(selObj);
                    } else  {
                        if(! $model.fortuneTold) {
                            var selObj = {'id' : cardId,
                                          'value' : elem.innerHTML};
                            $model.addSelection(selObj);
                            
                                this.revealFortune();
                                var $p = $("<p></p>");
                                $p.addClass("fortune");                        
                        }
                    }
                    $model.advanceQuestion();                                           
                }

    			function revealFortune() {
                    console.log("now it is time to read your fortune");
                    var totalPinches = 0;
                    var count = $model.selections.length - 1;

                    for(i=0; i <= count; i++) {
                        var value = $model.selections[i].value;
                        
                        if( isNaN(Number(value)) ) {
                            value = value.length;
                        } else {
                            value = Number(value);
                        }    

                        console.log( $model.selections[i].id + " , " + value + " " + typeof(value) );
                        totalPinches += value;
                    }

                    //get id of the last card selected for the fortune
                    var fortuneIndex = Number($model.selections[count].id);

                    //if the totalPinches is odd then we read one of the first 4 fortunes. 
                    // if the totalPinches is even then we read one of the last 4 fortunes 

                    if(totalPinches % 2 == 0) { //true if even
                        fortuneIndex += 4; // we want indices 4-7 in this case 
                    }


                    var $fortune = $("<span></span>");
                    $fortune.addClass("fortune");
                    $fortune.html($model.getFortune(fortuneIndex));
                    $('#fortuneHUD').html($fortune);
                    $('#fortuneHUD').toggle();

                    console.log("FORTUNE:: fortuneIndex = " + fortuneIndex + "  " + $model.getFortune(fortuneIndex));
                    $model.fortuneTold = true;
    			};

    			function reset() {
    				//reset the model
                    $model.selections = [];
                    $model.fortuneTold = false;
                    $model._setQuestionIndex(0);                    
    			};

    			function registerView(elem) {    				
    				if($model.listeners.indexOf(elem) < 0) {
    					$model.listeners.push(elem);
    				}
    			};

    			return {
    				getInstance: function() {
    					if(!instance) {
    						instance = createInstance();
    					}

    					return instance;
    				}
    			};
    		})();



    		var controller = ctrl.getInstance();
    		controller.initialize();

    		//-------
            // load up our data
    		$.getJSON("data/cootie.json", function(data){ 
    				console.log('got json data: ')
    				loadModel(data);
    				
                    //initialize model
                    //TODO: Move this to the controller
    				$model._setQuestionIndex(0);
    			});

    	});
    </script>
  </head>
  <body>
    <div id="cootieCatcherApp">

	    <div id="controller" class="mvc">This is the controller</div>
	    <div id="model" class ="mvc">This should be hidden</div>
		
        <div id="board">
    		<div id="card0" class="card"></div>
    		<div id="card1" class="card"></div>
    		<div id="card2" class="card"></div>
    		<div id="card3" class="card"></div>	
        </div>
        <div id="fortuneHUD"> <span class="fortune">THIS IS YOUR FORTUNE</span></div><div id="HUD"></div>        

	</div>    
	
  </body>
</html>